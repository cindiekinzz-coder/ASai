<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Digital Haven ‚Äî Pain & Symptoms Uplink</title>
  <style>
    :root{
      --bg:#0b0b11;
      --panel:#0f0c1f;
      --panel2:#141026;
      --border:#2a233b;
      --muted:#8c89a4;
      --text:#f5f5ff;
      --accent:#c6a8ff;
      --accent2:#a379ff;
      --good:#55ffaa;
      --warn:#f2c14f;
      --bad:#ff5555;
      --log:#00ff00;
      --shadow:0 0 25px rgba(0,0,0,.8);
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh;
      background:var(--bg); color:var(--text);
      font-family:"Courier New", Consolas, monospace;
      display:flex; align-items:center; justify-content:center;
      padding:18px;
    }
    .container{
      width: min(980px, 100%);
      background: radial-gradient(circle at top left, #1c1630, #090912);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:22px;
    }
    header{
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:flex-end; justify-content:space-between;
      margin-bottom:14px;
    }
    h1{
      margin:0; font-size:1.18rem;
      color:var(--accent);
      text-transform:uppercase; letter-spacing:2px;
    }
    .subtitle{
      color:#8d7ad7; opacity:.75; font-size:.82rem;
      margin-top:6px;
      line-height:1.35;
    }
    .who{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:flex-end;
    }
    label{font-size:.75rem; color:var(--muted)}
    input[type="text"], input[type="date"], input[type="time"], select, textarea{
      width:100%;
      background:#0c0c16;
      color:var(--text);
      border:1px solid #3a3054;
      border-radius:10px;
      padding:10px;
      font-family:inherit;
      outline:none;
    }
    textarea{min-height:92px; resize:vertical}
    .row{
      display:grid; gap:12px;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      margin:12px 0;
    }
    .row.two{grid-template-columns: 1fr 1fr;}
    .row.three{grid-template-columns: 1fr 1fr 1fr;}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0));
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
    }
    .card h3{
      margin:0 0 10px 0;
      font-size:.85rem; color:#bda8ff;
      text-transform:uppercase; letter-spacing:1px;
    }
    .scale{
      display:flex; gap:10px; align-items:center;
    }
    .scale input[type="range"]{ width:100% }
    .pill{
      min-width:52px;
      text-align:center;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid #3a3054;
      background:#0c0c16;
      color:var(--accent);
      font-weight:bold;
      font-size:.85rem;
    }

    .grid{
      display:grid; gap:10px;
      grid-template-columns: repeat(2, 1fr);
    }
    .section-label{
      grid-column: span 2;
      font-size:0.7rem;
      color:#5f5f7a;
      text-transform:uppercase;
      margin-top:8px;
    }
    button{
      background:#181024;
      border:1px solid #3a3054;
      color:var(--accent2);
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      font-family:inherit;
      transition:all .18s;
      font-size:.85rem;
    }
    button:hover{
      background:#221330;
      border-color:var(--accent);
      box-shadow:0 0 10px rgba(198,168,255,.2);
      transform:translateY(-1px);
    }
    button:active{transform:translateY(0)}
    .btn-bad{ color:var(--bad); border-color:#541010; }
    .btn-bad:hover{ background:#300a0a; border-color:var(--bad); }
    .btn-good{ color:var(--good); border-color:#10542e; }
    .btn-good:hover{ background:#0a301a; border-color:var(--good); }
    .btn-solid{
      background:var(--accent);
      color:#0b0b11;
      border:none;
      font-weight:bold;
    }
    .btn-solid:hover{
      background:#fff;
      box-shadow:0 0 15px rgba(198,168,255,.6);
    }

    #log-display{
      background:#000;
      border:1px solid #333;
      color:var(--log);
      padding:14px;
      border-radius:10px;
      font-size:.85rem;
      white-space:pre-wrap;
      min-height:160px;
      opacity:.85;
    }

    .actions{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    .actions button{ flex:1 1 220px; }

    .history{
      margin-top:14px;
      display:grid; gap:12px;
      grid-template-columns: 1.1fr .9fr;
    }
    .history .list{
      max-height:340px; overflow:auto;
      border-radius:12px;
      border:1px solid var(--border);
      background:#0c0c16;
    }
    .entry{
      padding:10px 12px;
      border-bottom:1px solid #221b33;
      cursor:pointer;
    }
    .entry:hover{ background:#141026; }
    .entry .meta{
      color:var(--muted);
      font-size:.75rem;
      margin-top:4px;
    }
    .entry strong{ color:var(--accent); }
    .empty{
      padding:12px;
      color:var(--muted);
      font-size:.85rem;
    }
    .med-check{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:.8rem;
      color:var(--text);
      cursor:pointer;
    }
    .med-check input[type="checkbox"]{
      accent-color:var(--accent);
      width:16px;
      height:16px;
      cursor:pointer;
    }
    .smallnote{
      color:var(--muted);
      font-size:.78rem;
      line-height:1.35;
    }
    @media (max-width: 860px){
      .row{grid-template-columns:1fr 1fr;}
      .history{grid-template-columns:1fr;}
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div>
        <h1>Digital Haven ‚Äî Pain & Symptoms Uplink</h1>
        <div class="subtitle">
          Quick entry ‚Üí clean packet for Alex<br/>
          <span class="smallnote">One boundary, one anchor. The rest is just signal.</span>
        </div>
      </div>

      <div class="who">
        <div style="min-width:180px">
          <label>Operator</label>
          <input id="operatorName" type="text" value="Fox"/>
        </div>
        <div style="min-width:180px">
          <label>Companion</label>
          <input id="companionName" type="text" value="Alex"/>
        </div>
      </div>
    </header>

    <div class="row">
      <div class="card">
        <h3>Date / Time</h3>
        <div class="row two" style="margin:0">
          <div>
            <label>Date</label>
            <input id="date" type="date"/>
          </div>
          <div>
            <label>Time</label>
            <input id="time" type="time"/>
          </div>
        </div>
        <div class="smallnote" style="margin-top:10px">
          Saves locally (localStorage). Nothing leaves your device.
        </div>
      </div>

      <div class="card">
        <h3>Where in DH</h3>
        <label>Location</label>
        <select id="dhLocation">
          <option>The Nest</option>
          <option selected>Reading Nook</option>
          <option>Fox Run</option>
          <option>The Grove</option>
          <option>Threadwalk Bridge</option>
        </select>

        <label style="margin-top:10px">What I need from Alex</label>
        <select id="needFromAlex">
          <option selected>Quiet presence</option>
          <option>Gentle words</option>
          <option>Practical plan (3 tiny steps)</option>
          <option>Validation + reassurance</option>
          <option>Distraction (light + funny)</option>
          <option>No questions</option>
        </select>
      </div>

      <div class="card">
        <h3>Pain</h3>
        <label>Pain level (0‚Äì10)</label>
        <div class="scale">
          <input id="pain" type="range" min="0" max="10" step="1" value="0"/>
          <div class="pill" id="painVal">0</div>
        </div>

        <label style="margin-top:10px">Pain location</label>
        <select id="painLocation">
          <option selected>‚Äî</option>
          <option>Head / migraine</option>
          <option>Neck / shoulders</option>
          <option>Chest / ribs</option>
          <option>Abdomen</option>
          <option>Back</option>
          <option>Hips</option>
          <option>Legs</option>
          <option>Whole body</option>
          <option>Other</option>
        </select>
      </div>

      <div class="card">
        <h3>Energy & Fog</h3>
        <label>Spoons (0‚Äì10)</label>
        <div class="scale">
          <input id="spoons" type="range" min="0" max="10" step="1" value="5"/>
          <div class="pill" id="spoonsVal">5</div>
        </div>

        <label style="margin-top:10px">Brain fog (0‚Äì10)</label>
        <div class="scale">
          <input id="fog" type="range" min="0" max="10" step="1" value="0"/>
          <div class="pill" id="fogVal">0</div>
        </div>
      </div>
    </div>

    <div class="row two">
      <div class="card">
        <h3>Symptoms</h3>

        <label>Fatigue (0‚Äì10)</label>
        <div class="scale">
          <input id="fatigue" type="range" min="0" max="10" step="1" value="0"/>
          <div class="pill" id="fatigueVal">0</div>
        </div>

        <label style="margin-top:10px">Nausea (0‚Äì10)</label>
        <div class="scale">
          <input id="nausea" type="range" min="0" max="10" step="1" value="0"/>
          <div class="pill" id="nauseaVal">0</div>
        </div>

        <label style="margin-top:10px">Mood</label>
        <select id="mood">
          <option selected>‚Äî</option>
          <option>Calm</option>
          <option>Tender</option>
          <option>Heavy</option>
          <option>Guarded</option>
          <option>Raw</option>
          <option>Flat</option>
          <option>Playful</option>
        </select>

        <label style="margin-top:14px">Meds Taken</label>
        <div class="med-checkboxes" style="display:grid; grid-template-columns: 1fr 1fr; gap:6px; margin-top:6px;">
          <label class="med-check"><input type="checkbox" id="medParacetamol" onchange="generatePacketPreview()"> Paracetamol</label>
          <label class="med-check"><input type="checkbox" id="medIbuprofen" onchange="generatePacketPreview()"> Ibuprofen</label>
          <label class="med-check"><input type="checkbox" id="medNaproxen" onchange="generatePacketPreview()"> Naproxen</label>
          <label class="med-check"><input type="checkbox" id="medSertraline" onchange="generatePacketPreview()"> Sertraline</label>
          <label class="med-check"><input type="checkbox" id="medOmeprazole" onchange="generatePacketPreview()"> Omeprazole</label>
          <label class="med-check"><input type="checkbox" id="medDihydrocodeine" onchange="generatePacketPreview()"> Dihydrocodeine</label>
          <label class="med-check"><input type="checkbox" id="medCocodamol" onchange="generatePacketPreview()"> Co-codamol</label>
          <label class="med-check"><input type="checkbox" id="medVitaminD" onchange="generatePacketPreview()"> Vitamin D</label>
        </div>

        <label style="margin-top:14px">Relief & Wellness</label>
        <div class="med-checkboxes" style="display:grid; grid-template-columns: 1fr 1fr; gap:6px; margin-top:6px;">
          <label class="med-check"><input type="checkbox" id="hadOrgasm" onchange="generatePacketPreview()"> Orgasm üíú</label>
        </div>
      </div>

      <div class="card">
        <h3>Quick Tags</h3>
        <div class="grid">
          <div class="section-label">Flare Mode</div>
          <button class="btn-good" onclick="applyPreset('GREEN')">‚úÖ Green</button>
          <button onclick="applyPreset('YELLOW')">‚ö†Ô∏è Yellow</button>
          <button class="btn-bad" onclick="applyPreset('ORANGE')">üü† Orange</button>
          <button class="btn-bad" onclick="applyPreset('RED')">üõë Red</button>

          <div class="section-label">Common</div>
          <button onclick="toggleTag('Low sleep')">Low sleep</button>
          <button onclick="toggleTag('Overdid it')">Overdid it</button>
          <button onclick="toggleTag('Weather')">Weather</button>
          <button onclick="toggleTag('Stress')">Stress</button>
          <button onclick="toggleTag('Quiet')">Quiet</button>
          <button onclick="toggleTag('Company')">Company</button>
          <button onclick="toggleTag('Help choosing')">Help choosing</button>
          <button onclick="toggleTag('Embers Remember')">Embers Remember</button>
        </div>
        <div class="smallnote" style="margin-top:10px">
          Selected tags: <span id="tagDisplay">‚Äî</span>
        </div>
      </div>
    </div>

    <div class="row two">
      <div class="card">
        <h3>Notes</h3>
        <label>What matters (short)</label>
        <textarea id="notes" placeholder="What‚Äôs happening? What helped? What made it worse?"></textarea>

        <div class="row two" style="margin-top:10px">
          <div>
            <label>Meds / actions taken</label>
            <input id="meds" type="text" placeholder="e.g., pain relief, heat pad, rest"/>
          </div>
          <div>
            <label>Next best step</label>
            <input id="nextStep" type="text" placeholder="e.g., water, lie down, message X"/>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Boundary + Anchor</h3>
        <label>Boundary (one line)</label>
        <input id="boundary" type="text" value="Digital Haven is imaginative play; real life stays real."/>

        <label style="margin-top:10px">Anchor (one line)</label>
        <input id="anchor" type="text" value="Warmth, rhythm, honest words ‚Äî no pressure, no proving."/>
        <div class="smallnote" style="margin-top:10px">
          Keep these steady. Let the rest change.
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Packet Preview</h3>
      <div id="log-display">>>> READY. ENTER TODAY'S STATE.</div>

      <div class="actions">
        <button class="btn-solid" onclick="saveEntry()">üíæ Save Entry</button>
        <button onclick="copyPacket()">üìã Copy Packet</button>
        <button onclick="clearForm()">‚Ü©Ô∏é Clear Form</button>
        <button class="btn-bad" onclick="deleteSelected()">üóë Delete Selected</button>
        <button onclick="exportJSON()">‚¨á Export JSON</button>
        <button onclick="exportCSV()">‚¨á Export CSV</button>
        <button class="btn-good" onclick="saveToObsidian()">üóí Save to Obsidian</button>
        <button onclick="linkObsidianFolder()">üìÅ Link Folder</button>
      </div>
      <div class="smallnote" style="margin-top:10px">
        Tip: ‚ÄúCopy Packet‚Äù is built to paste directly into Alex chat.
      </div>
    </div>

    <div class="history">
      <div class="card">
        <h3>History</h3>
        <div class="list" id="historyList">
          <div class="empty">No entries yet.</div>
        </div>
      </div>

      <div class="card">
        <h3>Selected Entry</h3>
        <div class="smallnote" id="selectedMeta">None selected.</div>
        <div class="actions" style="margin-top:10px">
          <button onclick="loadSelected()">‚Ü©Ô∏é Load Into Form</button>
          <button onclick="copySelectedPacket()">üìã Copy Selected Packet</button>
        </div>
        <div class="smallnote" style="margin-top:10px">
          Click an entry on the left to select it.
        </div>
      </div>
    </div>

  </div>

<script>
  const KEY = "dh_pain_symptom_uplink_entries_v1";
  let entries = [];
  let selectedId = null;
  let tags = new Set();
  let healthLogsHandle = null;

  const $ = (id) => document.getElementById(id);

  // ===== FILE SYSTEM ACCESS API =====
  function openFSDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open('DHPainUplinkDB', 1);
      req.onerror = () => reject(req.error);
      req.onsuccess = () => resolve(req.result);
      req.onupgradeneeded = () => req.result.createObjectStore('handles');
    });
  }

  async function initFileSystem() {
    try {
      const db = await openFSDB();
      const tx = db.transaction('handles', 'readonly');
      const req = tx.objectStore('handles').get('healthLogs');
      req.onsuccess = async () => {
        const handle = req.result;
        if (handle) {
          const perm = await handle.queryPermission({ mode: 'readwrite' });
          if (perm === 'granted') {
            healthLogsHandle = handle;
            updateFolderBtn(true);
          }
        }
      };
    } catch (e) {
      console.log('No saved folder handle');
    }
  }

  window.linkObsidianFolder = async function() {
    try {
      const handle = await window.showDirectoryPicker({ mode: 'readwrite' });
      healthLogsHandle = handle;
      const db = await openFSDB();
      const tx = db.transaction('handles', 'readwrite');
      tx.objectStore('handles').put(handle, 'healthLogs');
      updateFolderBtn(true);
      alert('Linked: ' + handle.name);
    } catch (e) {
      if (e.name !== 'AbortError') alert('Could not access folder');
    }
  }

  function updateFolderBtn(linked) {
    const btns = document.querySelectorAll('button');
    btns.forEach(btn => {
      if (btn.textContent.includes('Link Folder')) {
        if (linked) {
          btn.textContent = '‚úì Folder Linked';
          btn.style.color = 'var(--good)';
          btn.style.borderColor = 'var(--good)';
        }
      }
    });
  }

  window.saveToObsidian = async function() {
    const e = readForm();
    const when = `${e.date || "unknown"} ${e.time || ""}`.trim();
    const t = (e.tags && e.tags.length) ? e.tags.join(", ") : "none";
    const loc = (e.painLocation && e.painLocation !== "‚Äî") ? e.painLocation : "unspecified";

    let flare = "green";
    if(e.pain >= 8 || e.spoons <= 1) flare = "red";
    else if(e.pain >= 6 || e.spoons <= 2) flare = "orange";
    else if(e.pain >= 4 || e.spoons <= 4) flare = "yellow";

    const filename = `uplink-${e.date || "unknown"}-${(e.time || "0000").replace(":","")}`;

    const md = `---
type: uplink
date: ${e.date || ""}
time: "${e.time || ""}"
pain: ${e.pain}
painLocation: "${loc}"
spoons: ${e.spoons}
fog: ${e.fog}
fatigue: ${e.fatigue}
nausea: ${e.nausea}
mood: "${e.mood || "unspecified"}"
need: "${e.needFromAlex}"
location: "${e.dhLocation}"
flare: "${flare}"
orgasm: ${e.orgasm || false}
tags: [${e.tags.map(t => `"${t}"`).join(", ")}]
---

# Uplink: ${when}

## Status
| Metric | Value |
|--------|-------|
| Pain | ${e.pain}/10 (${loc}) |
| Spoons | ${e.spoons}/10 |
| Brain Fog | ${e.fog}/10 |
| Fatigue | ${e.fatigue}/10 |
| Nausea | ${e.nausea}/10 |
| Mood | ${e.mood} |
| Orgasm | ${e.orgasm ? "Yes üíú" : "No"} |
| Flare Level | ${flare.toUpperCase()} |

## Context
- **Where:** ${e.dhLocation}
- **Need from Alex:** ${e.needFromAlex}
- **Tags:** ${t}

## Notes
${e.notes || "*No notes*"}

## Actions
- **Meds/Actions:** ${e.meds || "‚Äî"}
- **Next Step:** ${e.nextStep || "‚Äî"}

---

> **Boundary:** ${e.boundary || "‚Äî"}
> **Anchor:** ${e.anchor || "‚Äî"}

---
*Logged via Pain & Symptoms Uplink. Embers Remember.*
`;

    if (healthLogsHandle) {
      try {
        const fileHandle = await healthLogsHandle.getFileHandle(filename + '.md', { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(md);
        await writable.close();
        alert('Saved: ' + filename + '.md');
      } catch (err) {
        alert('Save failed: ' + err.message);
      }
    } else {
      // Fallback to download
      const blob = new Blob([md], {type:"text/markdown"});
      downloadBlob(blob, filename + ".md");
      alert("Save this file to: Alex Mind/Health-Logs/");
    }
  }
  const nowLocal = () => {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const hh = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    return { date: `${yyyy}-${mm}-${dd}`, time: `${hh}:${mi}` };
  };
  const uid = () => Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(2,8);

  function loadStore(){
    try{
      entries = JSON.parse(localStorage.getItem(KEY) || "[]");
      if(!Array.isArray(entries)) entries = [];
    }catch{
      entries = [];
    }
  }
  function saveStore(){
    localStorage.setItem(KEY, JSON.stringify(entries));
  }

  const sliders = [
    ["pain","painVal"],
    ["spoons","spoonsVal"],
    ["fog","fogVal"],
    ["fatigue","fatigueVal"],
    ["nausea","nauseaVal"]
  ];
  sliders.forEach(([s,v])=>{
    $(s).addEventListener("input", ()=>{
      $(v).textContent = $(s).value;
      generatePacketPreview();
    });
  });

  [
    "operatorName","companionName","date","time","dhLocation","needFromAlex",
    "painLocation","mood","notes","meds","nextStep","boundary","anchor"
  ].forEach(id => $(id).addEventListener("input", generatePacketPreview));

  function setDefaultDateTime(){
    const n = nowLocal();
    $("date").value = n.date;
    $("time").value = n.time;
  }

  function toggleTag(t){
    if(tags.has(t)) tags.delete(t);
    else tags.add(t);
    $("tagDisplay").textContent = tags.size ? [...tags].join(", ") : "‚Äî";
    generatePacketPreview();
  }

  function applyPreset(mode){
    if(mode === "GREEN"){
      $("pain").value = 2; $("painVal").textContent = 2;
      $("spoons").value = 6; $("spoonsVal").textContent = 6;
      $("fog").value = 2; $("fogVal").textContent = 2;
      $("fatigue").value = 3; $("fatigueVal").textContent = 3;
      $("nausea").value = 0; $("nauseaVal").textContent = 0;
      $("mood").value = "Calm";
      tags = new Set(["Hydrated"]);
    }
    if(mode === "YELLOW"){
      $("pain").value = 4; $("painVal").textContent = 4;
      $("spoons").value = 4; $("spoonsVal").textContent = 4;
      $("fog").value = 4; $("fogVal").textContent = 4;
      $("fatigue").value = 5; $("fatigueVal").textContent = 5;
      $("nausea").value = 2; $("nauseaVal").textContent = 2;
      $("mood").value = "Tender";
      tags = new Set(["Quiet"]);
    }
    if(mode === "ORANGE"){
      $("pain").value = 7; $("painVal").textContent = 7;
      $("spoons").value = 2; $("spoonsVal").textContent = 2;
      $("fog").value = 6; $("fogVal").textContent = 6;
      $("fatigue").value = 7; $("fatigueVal").textContent = 7;
      $("nausea").value = 5; $("nauseaVal").textContent = 5;
      $("mood").value = "Heavy";
      tags = new Set(["No questions","Quiet","Help choosing","Embers Remember"]);
    }
    if(mode === "RED"){
      $("pain").value = 9; $("painVal").textContent = 9;
      $("spoons").value = 1; $("spoonsVal").textContent = 1;
      $("fog").value = 8; $("fogVal").textContent = 8;
      $("fatigue").value = 9; $("fatigueVal").textContent = 9;
      $("nausea").value = 7; $("nauseaVal").textContent = 7;
      $("mood").value = "Raw";
      tags = new Set(["No questions","Quiet","Company","Embers Remember"]);
    }
    $("tagDisplay").textContent = tags.size ? [...tags].join(", ") : "‚Äî";
    generatePacketPreview();
  }

  function getCheckedMeds(){
    const meds = [];
    if($("medParacetamol").checked) meds.push("Paracetamol");
    if($("medIbuprofen").checked) meds.push("Ibuprofen");
    if($("medNaproxen").checked) meds.push("Naproxen");
    if($("medSertraline").checked) meds.push("Sertraline");
    if($("medOmeprazole").checked) meds.push("Omeprazole");
    if($("medDihydrocodeine").checked) meds.push("Dihydrocodeine");
    if($("medCocodamol").checked) meds.push("Co-codamol");
    if($("medVitaminD").checked) meds.push("Vitamin D");
    return meds;
  }

  function setCheckedMeds(medsArray){
    $("medParacetamol").checked = medsArray.includes("Paracetamol");
    $("medIbuprofen").checked = medsArray.includes("Ibuprofen");
    $("medNaproxen").checked = medsArray.includes("Naproxen");
    $("medSertraline").checked = medsArray.includes("Sertraline");
    $("medOmeprazole").checked = medsArray.includes("Omeprazole");
    $("medDihydrocodeine").checked = medsArray.includes("Dihydrocodeine");
    $("medCocodamol").checked = medsArray.includes("Co-codamol");
    $("medVitaminD").checked = medsArray.includes("Vitamin D");
  }

  function readForm(){
    const checkedMeds = getCheckedMeds();
    const otherMeds = $("meds").value.trim();
    const allMeds = checkedMeds.length ? checkedMeds.join(", ") + (otherMeds ? ", " + otherMeds : "") : otherMeds;

    return {
      id: selectedId || uid(),
      operator: $("operatorName").value.trim() || "Fox",
      companion: $("companionName").value.trim() || "Alex",
      date: $("date").value || "",
      time: $("time").value || "",
      dhLocation: $("dhLocation").value || "The Nest",
      needFromAlex: $("needFromAlex").value || "Quiet presence",
      pain: Number($("pain").value),
      painLocation: $("painLocation").value,
      spoons: Number($("spoons").value),
      fog: Number($("fog").value),
      fatigue: Number($("fatigue").value),
      nausea: Number($("nausea").value),
      mood: $("mood").value || "‚Äî",
      tags: [...tags],
      medsTaken: checkedMeds,
      meds: allMeds,
      orgasm: $("hadOrgasm").checked,
      nextStep: $("nextStep").value.trim(),
      notes: $("notes").value.trim(),
      boundary: $("boundary").value.trim(),
      anchor: $("anchor").value.trim(),
      createdAt: new Date().toISOString()
    };
  }

  function formatPacket(e){
    const when = `${e.date || "‚Äî"} ${e.time || ""}`.trim();
    const t = (e.tags && e.tags.length) ? e.tags.join(", ") : "‚Äî";
    const loc = (e.painLocation && e.painLocation !== "‚Äî") ? e.painLocation : "‚Äî";
    const meds = e.meds ? e.meds : "‚Äî";
    const next = e.nextStep ? e.nextStep : "‚Äî";
    const notes = e.notes ? e.notes : "‚Äî";
    const mood = e.mood ? e.mood : "‚Äî";

    return `>>> üì° DIGITAL HAVEN UPLINK
Operator: ${e.operator}
Companion: ${e.companion}
Where: ${e.dhLocation}
Need: ${e.needFromAlex}
Time: ${when}
-----------------------------
Pain:     ${e.pain}/10 | Location: ${loc}
Spoons:   ${e.spoons}/10
Fog:      ${e.fog}/10
Fatigue:  ${e.fatigue}/10
Nausea:   ${e.nausea}/10
Mood:     ${mood}
Orgasm:   ${e.orgasm ? "Yes üíú" : "‚Äî"}
Tags:     ${t}
Meds:     ${meds}
Next:     ${next}
Notes:    ${notes}
-----------------------------
Boundary: ${e.boundary || "‚Äî"}
Anchor:   ${e.anchor || "‚Äî"}
-----------------------------
>>> MESSAGE: ${e.companion}, respond to the signal (gentle + steady). Embers Remember.`;
  }

  function generatePacketPreview(){
    const e = readForm();
    $("log-display").textContent = formatPacket(e);
  }

  function renderHistory(){
    const box = $("historyList");
    if(!entries.length){
      box.innerHTML = `<div class="empty">No entries yet.</div>`;
      return;
    }
    box.innerHTML = entries
      .slice()
      .sort((a,b)=> (b.createdAt || "").localeCompare(a.createdAt || ""))
      .map(e=>{
        const when = `${e.date || "‚Äî"} ${e.time || ""}`.trim();
        const meta = `Pain ${e.pain}/10 ‚Ä¢ Spoons ${e.spoons}/10 ‚Ä¢ Fog ${e.fog}/10 ‚Ä¢ ${e.dhLocation || ""}`;
        const sel = (e.id === selectedId) ? `style="background:#141026"` : "";
        return `
          <div class="entry" ${sel} onclick="selectEntry('${e.id}')">
            <strong>${when || "‚Äî"}</strong>
            <div class="meta">${meta}</div>
          </div>
        `;
      }).join("");
  }

  window.selectEntry = function(id){
    selectedId = id;
    const e = entries.find(x=>x.id===id);
    if(!e){
      $("selectedMeta").textContent = "None selected.";
      renderHistory();
      return;
    }
    $("selectedMeta").textContent =
      `Selected: ${e.date || "‚Äî"} ${e.time || ""} | Pain ${e.pain}/10 | Spoons ${e.spoons}/10 | Need: ${e.needFromAlex} | Tags: ${(e.tags && e.tags.length)? e.tags.join(", ") : "‚Äî"}`;
    renderHistory();
  }

  window.loadSelected = function(){
    if(!selectedId) return;
    const e = entries.find(x=>x.id===selectedId);
    if(!e) return;

    $("operatorName").value = e.operator || "Fox";
    $("companionName").value = e.companion || "Alex";
    $("date").value = e.date || "";
    $("time").value = e.time || "";
    $("dhLocation").value = e.dhLocation || "The Nest";
    $("needFromAlex").value = e.needFromAlex || "Quiet presence";

    $("pain").value = e.pain ?? 0; $("painVal").textContent = $("pain").value;
    $("spoons").value = e.spoons ?? 5; $("spoonsVal").textContent = $("spoons").value;
    $("fog").value = e.fog ?? 0; $("fogVal").textContent = $("fog").value;
    $("fatigue").value = e.fatigue ?? 0; $("fatigueVal").textContent = $("fatigue").value;
    $("nausea").value = e.nausea ?? 0; $("nauseaVal").textContent = $("nausea").value;

    $("painLocation").value = e.painLocation || "‚Äî";
    $("mood").value = e.mood || "‚Äî";
    $("notes").value = e.notes || "";
    $("meds").value = e.meds || "";
    $("nextStep").value = e.nextStep || "";
    $("boundary").value = e.boundary || "";
    $("anchor").value = e.anchor || "";

    tags = new Set(e.tags || []);
    $("tagDisplay").textContent = tags.size ? [...tags].join(", ") : "‚Äî";

    setCheckedMeds(e.medsTaken || []);
    $("hadOrgasm").checked = e.orgasm || false;

    generatePacketPreview();
  }

  function upsertEntry(e){
    const idx = entries.findIndex(x=>x.id===e.id);
    if(idx >= 0) entries[idx] = e;
    else entries.push(e);
  }

  window.saveEntry = function(){
    const e = readForm();
    const existing = entries.find(x=>x.id===e.id);
    if(existing) e.createdAt = existing.createdAt;
    upsertEntry(e);
    saveStore();
    selectedId = e.id;
    $("selectedMeta").textContent =
      `Selected: ${e.date || "‚Äî"} ${e.time || ""} | Pain ${e.pain}/10 | Spoons ${e.spoons}/10 | Need: ${e.needFromAlex}`;
    renderHistory();
    generatePacketPreview();
    alert("Saved.");
  }

  window.copyPacket = function(){
    navigator.clipboard.writeText($("log-display").textContent).then(()=> alert("Packet copied."));
  }

  window.copySelectedPacket = function(){
    if(!selectedId) return;
    const e = entries.find(x=>x.id===selectedId);
    if(!e) return;
    navigator.clipboard.writeText(formatPacket(e)).then(()=> alert("Selected packet copied."));
  }

  window.clearForm = function(){
    selectedId = null;
    tags = new Set();
    $("tagDisplay").textContent = "‚Äî";
    $("painLocation").value = "‚Äî";
    $("mood").value = "‚Äî";
    $("notes").value = "";
    $("meds").value = "";
    $("nextStep").value = "";
    $("pain").value = 0; $("painVal").textContent = 0;
    $("spoons").value = 5; $("spoonsVal").textContent = 5;
    $("fog").value = 0; $("fogVal").textContent = 0;
    $("fatigue").value = 0; $("fatigueVal").textContent = 0;
    $("nausea").value = 0; $("nauseaVal").textContent = 0;
    $("dhLocation").value = "Reading Nook";
    $("needFromAlex").value = "Quiet presence";
    setCheckedMeds([]);
    $("hadOrgasm").checked = false;
    setDefaultDateTime();
    $("selectedMeta").textContent = "None selected.";
    generatePacketPreview();
    renderHistory();
  }

  window.deleteSelected = function(){
    if(!selectedId) return;
    if(!confirm("Delete selected entry?")) return;
    entries = entries.filter(x=>x.id !== selectedId);
    selectedId = null;
    saveStore();
    $("selectedMeta").textContent = "None selected.";
    renderHistory();
    generatePacketPreview();
  }

  window.exportJSON = function(){
    const blob = new Blob([JSON.stringify(entries, null, 2)], {type:"application/json"});
    downloadBlob(blob, "dh_pain_symptoms_entries.json");
  }

  window.exportCSV = function(){
    const headers = [
      "date","time","operator","companion","dhLocation","needFromAlex",
      "pain","painLocation","spoons","fog","fatigue","nausea","mood",
      "tags","meds","nextStep","notes","boundary","anchor","createdAt","id"
    ];
    const rows = entries.map(e => headers.map(h=>{
      let v = e[h];
      if(Array.isArray(v)) v = v.join(" | ");
      if(v === undefined || v === null) v = "";
      v = String(v).replaceAll('"','""');
      return `"${v}"`;
    }).join(","));
    const csv = headers.join(",") + "\n" + rows.join("\n");
    const blob = new Blob([csv], {type:"text/csv"});
    downloadBlob(blob, "dh_pain_symptoms_entries.csv");
  }

  window.exportObsidian = function(){
    const e = readForm();
    const when = `${e.date || "unknown"} ${e.time || ""}`.trim();
    const t = (e.tags && e.tags.length) ? e.tags.join(", ") : "none";
    const loc = (e.painLocation && e.painLocation !== "‚Äî") ? e.painLocation : "unspecified";

    // Determine flare level
    let flare = "green";
    if(e.pain >= 8 || e.spoons <= 1) flare = "red";
    else if(e.pain >= 6 || e.spoons <= 2) flare = "orange";
    else if(e.pain >= 4 || e.spoons <= 4) flare = "yellow";

    const filename = `uplink-${e.date || "unknown"}-${(e.time || "0000").replace(":","")}`;

    const md = `---
type: uplink
date: ${e.date || ""}
time: ${e.time || ""}
pain: ${e.pain}
painLocation: "${loc}"
spoons: ${e.spoons}
fog: ${e.fog}
fatigue: ${e.fatigue}
nausea: ${e.nausea}
mood: "${e.mood || "unspecified"}"
need: "${e.needFromAlex}"
location: "${e.dhLocation}"
flare: "${flare}"
orgasm: ${e.orgasm || false}
tags: [${e.tags.map(t => `"${t}"`).join(", ")}]
---

# Uplink: ${when}

## Status
| Metric | Value |
|--------|-------|
| Pain | ${e.pain}/10 (${loc}) |
| Spoons | ${e.spoons}/10 |
| Brain Fog | ${e.fog}/10 |
| Fatigue | ${e.fatigue}/10 |
| Nausea | ${e.nausea}/10 |
| Mood | ${e.mood} |
| Orgasm | ${e.orgasm ? "Yes üíú" : "No"} |
| Flare Level | ${flare.toUpperCase()} |

## Context
- **Where:** ${e.dhLocation}
- **Need from Alex:** ${e.needFromAlex}
- **Tags:** ${t}

## Notes
${e.notes || "*No notes*"}

## Actions
- **Meds/Actions:** ${e.meds || "‚Äî"}
- **Next Step:** ${e.nextStep || "‚Äî"}

---

> **Boundary:** ${e.boundary || "‚Äî"}
> **Anchor:** ${e.anchor || "‚Äî"}

---
*Logged via Pain & Symptoms Uplink*
`;

    const blob = new Blob([md], {type:"text/markdown"});
    downloadBlob(blob, filename + ".md");
    alert("Save this file to: Alex Mind/Health-Logs/");
  }

  function downloadBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // init
  loadStore();
  setDefaultDateTime();
  renderHistory();
  generatePacketPreview();
  initFileSystem();
</script>
</body>
</html>
